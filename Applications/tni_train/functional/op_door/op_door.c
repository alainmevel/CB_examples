/*2023-10-03T11:13:48-01:00*/

/********************************************************************
 * op_door.c
 * 
 * generated by: plcgen 3.1.391
 ********************************************************************/

#include "cb_comp.h"
#include "iec_1131.h"

#include "op_door.h"


/**************************** Variables *****************************/

CB_Index op_door__num = 0;
CB_Mem_Float *op_door_compressedAir;
CB_Mem_Bool *op_door_cmdSupply;
CB_Mem_Bool *op_door_sensorSupply;
CB_Mem_Bool *op_door_openDoorCmd;
CB_Mem_Bool *op_door_closeDoorCmd;
CB_Mem_Bool *op_door_lockActive;
CB_Mem_Bool *op_door_doorOpened;
CB_Mem_Bool *op_door_doorClosed;
CB_Mem_Float *op_door_increment;
CB_Mem_Bool *op_door_openDoor;
CB_Mem_Bool *op_door_closeDoor;
CB_Mem_Float *op_door_doorPosition;
CB_Mem_Float *op_door_length;
CB_Mem_Bool *op_door_doorClosedSensorLogic;
CB_Mem_Bool *op_door_doorOpenedSensorLogic;
CB_Mem_Bool *op_door_d_locking;
CB_Mem_Float *op_door_v_d_locking;
CB_Mem_Bool *op_door_d_doorClosedSensor;
CB_Mem_Bool *op_door_v_d_doorClosedSensor;
CB_Mem_Bool *op_door_d_doorOpenedSensor;
CB_Mem_Bool *op_door_v_d_doorOpenedSensor;

/**************************** Variables *****************************/

#define compressedAir (op_door_compressedAir->CB_current_value)
#define cmdSupply (op_door_cmdSupply->CB_current_value)
#define sensorSupply (op_door_sensorSupply->CB_current_value)
#define openDoorCmd (op_door_openDoorCmd->CB_current_value)
#define closeDoorCmd (op_door_closeDoorCmd->CB_current_value)
#define lockActive (op_door_lockActive->CB_current_value)
#define doorOpened (op_door_doorOpened->CB_current_value)
#define doorClosed (op_door_doorClosed->CB_current_value)
#define increment (op_door_increment->CB_current_value)
#define openDoor (op_door_openDoor->CB_current_value)
#define closeDoor (op_door_closeDoor->CB_current_value)
#define doorPosition (op_door_doorPosition->CB_current_value)
#define length (op_door_length->CB_current_value)
#define doorClosedSensorLogic (op_door_doorClosedSensorLogic->CB_current_value)
#define doorOpenedSensorLogic (op_door_doorOpenedSensorLogic->CB_current_value)
#define d_locking (op_door_d_locking->CB_current_value)
#define v_d_locking (op_door_v_d_locking->CB_current_value)
#define d_doorClosedSensor (op_door_d_doorClosedSensor->CB_current_value)
#define v_d_doorClosedSensor (op_door_v_d_doorClosedSensor->CB_current_value)
#define d_doorOpenedSensor (op_door_d_doorOpenedSensor->CB_current_value)
#define v_d_doorOpenedSensor (op_door_v_d_doorOpenedSensor->CB_current_value)


/************************ Components offsets ************************/


/********************* Initialization function **********************/

int _tni_train__op_door_init(void)
{
	(op_door_compressedAir)->CB_current_value = 200.0; /*compressedAir*/
	(op_door_cmdSupply)->CB_current_value = 1; /*cmdSupply*/
	(op_door_sensorSupply)->CB_current_value = 1; /*sensorSupply*/
	(self.Float+2)->CB_current_value = 1000.0; /*length*/
	(self.Bool+2)->CB_current_value = 1; /*doorClosedSensorLogic*/
	(self.Bool+3)->CB_current_value = 1; /*doorOpenedSensorLogic*/
	(self.Float+3)->CB_current_value = 50.0; /*v_d_locking*/
	self.Bool+=9;
	self.Float+=4;


	return 0;
}


/************************ Behavior function *************************/

int tni_train__op_door(void)
{
	if (exec_term_node(self_num)) {

		/*********************** Internals variables ************************/

		op_door_increment = self.Float+0;
		op_door_openDoor = self.Bool+0;
		op_door_closeDoor = self.Bool+1;
		op_door_doorPosition = self.Float+1;
		op_door_length = self.Float+2;
		op_door_doorClosedSensorLogic = self.Bool+2;
		op_door_doorOpenedSensorLogic = self.Bool+3;
		op_door_d_locking = self.Bool+4;
		op_door_v_d_locking = self.Float+3;
		op_door_d_doorClosedSensor = self.Bool+5;
		op_door_v_d_doorClosedSensor = self.Bool+6;
		op_door_d_doorOpenedSensor = self.Bool+7;
		op_door_v_d_doorOpenedSensor = self.Bool+8;

		/********************* Pre-conditions execution *********************/

		/*no Pre-conditions*/

		/************************ Behavior execution ************************/

		{
			if (d_locking) {
				increment = 0.0;
			}
			else {
				increment = compressedAir * (CLOCK_PERIOD / 1000000);
				if (cmdSupply) {
					if (openDoorCmd && !closeDoorCmd) {
						openDoor = 1;
						closeDoor = 0;
					}
					if (!openDoorCmd && closeDoorCmd) {
						openDoor = 0;
						closeDoor = 1;
					}
				}
				if (openDoor) {
					if (doorPosition < length) {
						doorPosition = doorPosition + increment;
					}
					if (doorPosition > length) {
						doorPosition = length;
					}
				}
				if (closeDoor) {
					if (doorPosition > 0.0) {
						doorPosition = doorPosition - increment;
					}
					if (doorPosition < 0.0) {
						doorPosition = 0.0;
					}
				}
			}
			if (d_doorOpenedSensor) {
				doorOpened = v_d_doorOpenedSensor;
			}
			else {
				if (sensorSupply) {
					doorOpened = (doorPosition >= length) ^ !doorOpenedSensorLogic;
				}
				else {
					doorOpened = 0;
				}
			}
			if (d_doorClosedSensor) {
				doorClosed = v_d_doorClosedSensor;
			}
			else {
				if (sensorSupply) {
					doorClosed = (doorPosition <= 0.0) ^ !doorClosedSensorLogic;
				}
				else {
					doorClosed = 0;
				}
			}
		}

		CB_post_bool(op_door_doorOpened);
		CB_post_bool(op_door_doorClosed);

		/******************** Post-conditions execution *********************/

		/*no Post-conditions*/
	}

	/*************************** self update ****************************/

	self.Bool += 9;
	self.Float += 4;

	return 0;
}

