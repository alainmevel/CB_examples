/*2023-10-03T11:13:37-01:00*/

/********************************************************************
 * mode.c
 * 
 * generated by: plcgen 3.1.391
 ********************************************************************/

#include "cb_comp.h"
#include "iec_1131.h"

#include "mode.h"


/**************************** Variables *****************************/

CB_Index mode__num = 0;
CB_Mem_Bool *mode_powerUp;
CB_Mem_Bool *mode_emergencyStop;
CB_Mem_Bool *mode_manualSwitch;
CB_Mem_Bool *mode_autoSwitch;
CB_Mem_Bool *mode_startCyclePB;
CB_Mem_Bool *mode_endCyclePB;
CB_Mem_Bool *mode_acknowledgePB;
CB_Mem_Bool *mode_cycleEnd;
CB_Mem_Bool *mode_generalFault;
CB_Mem_Bool *mode_live;
CB_Mem_Bool *mode_autoMode;
CB_Mem_Bool *mode_manualMode;
CB_Mem_Bool *mode_cycleInProgress;
CB_Mem_Bool *mode_endCycleRequest;
CB_Mem_Bool *mode_emergencyStopState;
CB_Mem_Bool *mode_sr1_Q1;
CB_Mem_Int *mode_sr1_i_sr;
CB_Mem_Bool *mode_powerUp_PREV;
CB_Mem_Int *mode_powerUp_EDGE;
CB_Mem_Bool *mode_acknowledgePB_PREV;
CB_Mem_Int *mode_acknowledgePB_EDGE;

/**************************** Variables *****************************/

#define powerUp (mode_powerUp->CB_current_value)
#define emergencyStop (mode_emergencyStop->CB_current_value)
#define manualSwitch (mode_manualSwitch->CB_current_value)
#define autoSwitch (mode_autoSwitch->CB_current_value)
#define startCyclePB (mode_startCyclePB->CB_current_value)
#define endCyclePB (mode_endCyclePB->CB_current_value)
#define acknowledgePB (mode_acknowledgePB->CB_current_value)
#define cycleEnd (mode_cycleEnd->CB_current_value)
#define generalFault (mode_generalFault->CB_current_value)
#define live (mode_live->CB_current_value)
#define autoMode (mode_autoMode->CB_current_value)
#define manualMode (mode_manualMode->CB_current_value)
#define cycleInProgress (mode_cycleInProgress->CB_current_value)
#define endCycleRequest (mode_endCycleRequest->CB_current_value)
#define emergencyStopState (mode_emergencyStopState->CB_current_value)
#define sr1_Q1 (mode_sr1_Q1->CB_current_value)
#define sr1_i_sr (*((short *)&(mode_sr1_i_sr->CB_current_value) + ALIGN_OFFSET_SHORT))
#define powerUp_PREV (mode_powerUp_PREV->CB_current_value)
#define powerUp_EDGE (mode_powerUp_EDGE->CB_current_value)
#define acknowledgePB_PREV (mode_acknowledgePB_PREV->CB_current_value)
#define acknowledgePB_EDGE (mode_acknowledgePB_EDGE->CB_current_value)


/************************ Components offsets ************************/


/********************* Initialization function **********************/

int _batch__mode_init(void)
{
	self.Bool+=4;
	self.Int+=3;


	return 0;
}


/************************ Behavior function *************************/

int batch__mode(void)
{
	if (exec_term_node(self_num)) {

		/*********************** Internals variables ************************/

		mode_emergencyStopState = self.Bool+0;
		mode_sr1_Q1 = self.Bool+1;
		mode_sr1_i_sr = self.Int+0;
		mode_powerUp_PREV = self.Bool+2;
		mode_powerUp_EDGE = self.Int+1;
		mode_acknowledgePB_PREV = self.Bool+3;
		mode_acknowledgePB_EDGE = self.Int+2;

		/********************* Pre-conditions execution *********************/

		/*no Pre-conditions*/

		/************************ Behavior execution ************************/

		{
			unsigned char _5;
			unsigned char _17;
			acknowledgePB_EDGE = CB_edge_bool(acknowledgePB, acknowledgePB_PREV);
			powerUp_EDGE = CB_edge_bool(powerUp, powerUp_PREV);
			_5 = powerUp_EDGE > 0;
			sr1_Q1 = sr_Q1(_5 && !live, _5 && live, &sr1_i_sr);
			live = sr1_Q1;
			if (!emergencyStop) {
				emergencyStopState = 1;
			}
			if ((acknowledgePB_EDGE < 0) && emergencyStop) {
				emergencyStopState = 0;
			}
			_17 = (live && !generalFault) && !emergencyStopState;
			autoMode = (_17 && autoSwitch) && !manualSwitch;
			manualMode = (_17 && !autoSwitch) && manualSwitch;
			cycleInProgress = ((cycleInProgress || startCyclePB) && !cycleEnd) && autoMode;
			endCycleRequest = (endCyclePB || endCycleRequest) && cycleInProgress;
			acknowledgePB_PREV = acknowledgePB;
			powerUp_PREV = powerUp;
		}

		if(nb_alloc > 0) {
			free_all_alloc();
		}

		CB_post_bool(mode_live);
		CB_post_bool(mode_autoMode);
		CB_post_bool(mode_manualMode);
		CB_post_bool(mode_cycleInProgress);
		CB_post_bool(mode_endCycleRequest);

		/******************** Post-conditions execution *********************/

		/*no Post-conditions*/
	}

	/*************************** self update ****************************/

	self.Bool += 4;
	self.Int += 3;

	return 0;
}

