/*2023-10-03T11:13:44-01:00*/

/********************************************************************
 * mode.c
 * 
 * generated by: plcgen 3.1.391
 ********************************************************************/

#include "cb_comp.h"
#include "iec_1131.h"

#include "mode.h"


/**************************** Variables *****************************/

CB_Index mode__num = 0;
CB_Mem_Bool *mode_powerUpPB;
CB_Mem_Bool *mode_startCyclePB;
CB_Mem_Bool *mode_emergencyStop;
CB_Mem_Bool *mode_batchCycle;
CB_Mem_Bool *mode_pieceCycle;
CB_Mem_Bool *mode_autoSwitch;
CB_Mem_Bool *mode_manualSwitch;
CB_Mem_Bool *mode_cycleEnd;
CB_Mem_Bool *mode_acknowledgePB;
CB_Mem_Bool *mode_live;
CB_Mem_Bool *mode_autoMode;
CB_Mem_Bool *mode_manualMode;
CB_Mem_Bool *mode_emptyProd;
CB_Mem_Bool *mode_unitProd;
CB_Mem_Bool *mode_batchProd;
CB_Mem_Bool *mode_emergencyState;
CB_Mem_Bool *mode_sr1_Q1;
CB_Mem_Int *mode_sr1_i_sr;
CB_Mem_Bool *mode_powerUpPB_PREV;
CB_Mem_Int *mode_powerUpPB_EDGE;
CB_Mem_Bool *mode_acknowledgePB_PREV;
CB_Mem_Int *mode_acknowledgePB_EDGE;
CB_Mem_Bool *mode_startCyclePB_PREV;
CB_Mem_Int *mode_startCyclePB_EDGE;
CB_Mem_Bool *mode_cycleEnd_PREV;
CB_Mem_Int *mode_cycleEnd_EDGE;

/**************************** Variables *****************************/

#define powerUpPB (mode_powerUpPB->CB_current_value)
#define startCyclePB (mode_startCyclePB->CB_current_value)
#define emergencyStop (mode_emergencyStop->CB_current_value)
#define batchCycle (mode_batchCycle->CB_current_value)
#define pieceCycle (mode_pieceCycle->CB_current_value)
#define autoSwitch (mode_autoSwitch->CB_current_value)
#define manualSwitch (mode_manualSwitch->CB_current_value)
#define cycleEnd (mode_cycleEnd->CB_current_value)
#define acknowledgePB (mode_acknowledgePB->CB_current_value)
#define live (mode_live->CB_current_value)
#define autoMode (mode_autoMode->CB_current_value)
#define manualMode (mode_manualMode->CB_current_value)
#define emptyProd (mode_emptyProd->CB_current_value)
#define unitProd (mode_unitProd->CB_current_value)
#define batchProd (mode_batchProd->CB_current_value)
#define emergencyState (mode_emergencyState->CB_current_value)
#define sr1_Q1 (mode_sr1_Q1->CB_current_value)
#define sr1_i_sr (*((short *)&(mode_sr1_i_sr->CB_current_value) + ALIGN_OFFSET_SHORT))
#define powerUpPB_PREV (mode_powerUpPB_PREV->CB_current_value)
#define powerUpPB_EDGE (mode_powerUpPB_EDGE->CB_current_value)
#define acknowledgePB_PREV (mode_acknowledgePB_PREV->CB_current_value)
#define acknowledgePB_EDGE (mode_acknowledgePB_EDGE->CB_current_value)
#define startCyclePB_PREV (mode_startCyclePB_PREV->CB_current_value)
#define startCyclePB_EDGE (mode_startCyclePB_EDGE->CB_current_value)
#define cycleEnd_PREV (mode_cycleEnd_PREV->CB_current_value)
#define cycleEnd_EDGE (mode_cycleEnd_EDGE->CB_current_value)


/************************ Components offsets ************************/


/********************* Initialization function **********************/

int _drill__mode_init(void)
{
	self.Bool+=6;
	self.Int+=5;


	return 0;
}


/************************ Behavior function *************************/

int drill__mode(void)
{
	if (exec_term_node(self_num)) {

		/*********************** Internals variables ************************/

		mode_emergencyState = self.Bool+0;
		mode_sr1_Q1 = self.Bool+1;
		mode_sr1_i_sr = self.Int+0;
		mode_powerUpPB_PREV = self.Bool+2;
		mode_powerUpPB_EDGE = self.Int+1;
		mode_acknowledgePB_PREV = self.Bool+3;
		mode_acknowledgePB_EDGE = self.Int+2;
		mode_startCyclePB_PREV = self.Bool+4;
		mode_startCyclePB_EDGE = self.Int+3;
		mode_cycleEnd_PREV = self.Bool+5;
		mode_cycleEnd_EDGE = self.Int+4;

		/********************* Pre-conditions execution *********************/

		/*no Pre-conditions*/

		/************************ Behavior execution ************************/

		{
			unsigned char _5;
			unsigned char _46;
			unsigned char _42;
			unsigned char _45;
			startCyclePB_EDGE = CB_edge_bool(startCyclePB, startCyclePB_PREV);
			cycleEnd_EDGE = CB_edge_bool(cycleEnd, cycleEnd_PREV);
			powerUpPB_EDGE = CB_edge_bool(powerUpPB, powerUpPB_PREV);
			acknowledgePB_EDGE = CB_edge_bool(acknowledgePB, acknowledgePB_PREV);
			_5 = powerUpPB_EDGE > 0;
			sr1_Q1 = sr_Q1(_5 && !live, _5 && live, &sr1_i_sr);
			live = sr1_Q1;
			if (!emergencyStop) {
				emergencyState = 1;
			}
			if ((acknowledgePB_EDGE < 0) && emergencyStop) {
				emergencyState = 0;
			}
			_46 = live && !emergencyState;
			autoMode = (_46 && autoSwitch) && !manualSwitch;
			manualMode = (_46 && !autoSwitch) && manualSwitch;
			_42 = ((startCyclePB_EDGE > 0) && cycleEnd) && autoMode;
			if ((((_42 && pieceCycle) && !batchCycle) && !batchProd) && !emptyProd) {
				unitProd = 1;
			}
			if ((((_42 && !pieceCycle) && batchCycle) && !unitProd) && !emptyProd) {
				batchProd = 1;
			}
			if ((((_42 && !pieceCycle) && !batchCycle) && !unitProd) && !batchProd) {
				emptyProd = 1;
			}
			_45 = cycleEnd_EDGE < 0;
			if (_45 && emptyProd) {
				emptyProd = 0;
			}
			if (_45 && unitProd) {
				unitProd = 0;
			}
			if ((_45 && batchProd) && !autoMode) {
				batchProd = 0;
			}
			startCyclePB_PREV = startCyclePB;
			cycleEnd_PREV = cycleEnd;
			powerUpPB_PREV = powerUpPB;
			acknowledgePB_PREV = acknowledgePB;
		}

		if(nb_alloc > 0) {
			free_all_alloc();
		}

		CB_post_bool(mode_live);
		CB_post_bool(mode_autoMode);
		CB_post_bool(mode_manualMode);
		CB_post_bool(mode_emptyProd);
		CB_post_bool(mode_unitProd);
		CB_post_bool(mode_batchProd);

		/******************** Post-conditions execution *********************/

		/*no Post-conditions*/
	}

	/*************************** self update ****************************/

	self.Bool += 6;
	self.Int += 5;

	return 0;
}

