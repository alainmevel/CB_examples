/*2024-04-12T14:05:57-01:00*/

/********************************************************************
 * kneading.c
 * 
 * generated by: plcgen 3.1.391
 ********************************************************************/

#include "cb_comp.h"
#include "iec_1131.h"

#include "kneading.h"


/**************************** Variables *****************************/

CB_Index kneading__num = 0;
CB_Mem_Bool *kneading_kneadingRequest;
CB_Mem_Bool *kneading_cycleInProgress;
CB_Mem_Int *kneading_mixtureLevel;
CB_Mem_Bool *kneading_kneadingOK;
CB_Mem_Bool *kneading_knead;
CB_Mem_Bool *kneading_clean;
CB_Mem_Bool *kneading_cleaningEnd;
CB_Mem_Bool *kneading_evacuateMixture;
CB_Mem_Bool *kneading_evacMixtureEnd;
CB_Mem_Int *kneading_nbCycles;
CB_Mem_Int *kneading_kneadingDuration;
CB_Mem_Int *kneading_nbOfCleanCycles;
CB_Mem_Int *kneading_cleaningDuration;
CB_Mem_Bool *kneading__X_10;
CB_Mem_Bool *kneading__X_11;
CB_Mem_Bool *kneading__X_12;
CB_Mem_Bool *kneading__X_13;
CB_Mem_Bool *kneading__X_14;
CB_Mem_Bool *kneading__X_15;
CB_Mem_Bool *kneading__X_17;
CB_Mem_Bool *kneading__X_16;
CB_Mem_Int *kneading__TIMER_13;
CB_Mem_Int *kneading__TIMER_17;
CB_Mem_Int *kneading__TIMER_16;
CB_Mem_Bool *kneading__X_13_PREV;
CB_Mem_Bool *kneading__X_17_PREV;
CB_Mem_Bool *kneading__X_16_PREV;
CB_Mem_Bool *kneading__X_12_PREV;
CB_Mem_Bool *kneading__X_14_PREV;
CB_Mem_Bool *kneading__X_15_PREV;

/**************************** Variables *****************************/

#define kneadingRequest (kneading_kneadingRequest->CB_current_value)
#define cycleInProgress (kneading_cycleInProgress->CB_current_value)
#define mixtureLevel (kneading_mixtureLevel->CB_current_value)
#define kneadingOK (kneading_kneadingOK->CB_current_value)
#define knead (kneading_knead->CB_current_value)
#define clean (kneading_clean->CB_current_value)
#define cleaningEnd (kneading_cleaningEnd->CB_current_value)
#define evacuateMixture (kneading_evacuateMixture->CB_current_value)
#define evacMixtureEnd (kneading_evacMixtureEnd->CB_current_value)
#define nbCycles (kneading_nbCycles->CB_current_value)
#define kneadingDuration (kneading_kneadingDuration->CB_current_value)
#define nbOfCleanCycles (kneading_nbOfCleanCycles->CB_current_value)
#define cleaningDuration (kneading_cleaningDuration->CB_current_value)
#define _X_10 (kneading__X_10->CB_current_value)
#define _X_11 (kneading__X_11->CB_current_value)
#define _X_12 (kneading__X_12->CB_current_value)
#define _X_13 (kneading__X_13->CB_current_value)
#define _X_14 (kneading__X_14->CB_current_value)
#define _X_15 (kneading__X_15->CB_current_value)
#define _X_17 (kneading__X_17->CB_current_value)
#define _X_16 (kneading__X_16->CB_current_value)
#define _TIMER_13 (*((unsigned long *)&(kneading__TIMER_13->CB_current_value)))
#define _TIMER_17 (*((unsigned long *)&(kneading__TIMER_17->CB_current_value)))
#define _TIMER_16 (*((unsigned long *)&(kneading__TIMER_16->CB_current_value)))
#define _X_13_PREV (kneading__X_13_PREV->CB_current_value)
#define _X_17_PREV (kneading__X_17_PREV->CB_current_value)
#define _X_16_PREV (kneading__X_16_PREV->CB_current_value)
#define _X_12_PREV (kneading__X_12_PREV->CB_current_value)
#define _X_14_PREV (kneading__X_14_PREV->CB_current_value)
#define _X_15_PREV (kneading__X_15_PREV->CB_current_value)


/************************ Components offsets ************************/


/********************* Initialization function **********************/

int _copie_batch__kneading_init(void)
{
	(self.Int+1)->CB_current_value = 20; /*kneadingDuration*/
	(self.Int+2)->CB_current_value = 10; /*nbOfCleanCycles*/
	(self.Int+3)->CB_current_value = 30; /*cleaningDuration*/
	(self.Bool+0)->CB_current_value = 1; /*_X_10*/
	self.Bool+=14;
	self.Int+=7;


	return 0;
}


/************************ Behavior function *************************/

int copie_batch__kneading(void)
{
	if (exec_term_node(self_num)) {

		/*********************** Internals variables ************************/

		kneading_nbCycles = self.Int+0;
		kneading_kneadingDuration = self.Int+1;
		kneading_nbOfCleanCycles = self.Int+2;
		kneading_cleaningDuration = self.Int+3;
		kneading__X_10 = self.Bool+0;
		kneading__X_11 = self.Bool+1;
		kneading__X_12 = self.Bool+2;
		kneading__X_13 = self.Bool+3;
		kneading__X_14 = self.Bool+4;
		kneading__X_15 = self.Bool+5;
		kneading__X_17 = self.Bool+6;
		kneading__X_16 = self.Bool+7;
		kneading__TIMER_13 = self.Int+4;
		kneading__TIMER_17 = self.Int+5;
		kneading__TIMER_16 = self.Int+6;
		kneading__X_13_PREV = self.Bool+8;
		kneading__X_17_PREV = self.Bool+9;
		kneading__X_16_PREV = self.Bool+10;
		kneading__X_12_PREV = self.Bool+11;
		kneading__X_14_PREV = self.Bool+12;
		kneading__X_15_PREV = self.Bool+13;

		/********************* Pre-conditions execution *********************/

		/*no Pre-conditions*/

		/************************ Behavior execution ************************/

		{
			unsigned char _Y_9;
			unsigned char _Y_15;
			unsigned char _Y_14;
			unsigned char _Y_13;
			unsigned char _Y_12;
			unsigned char _Y_11;
			unsigned char _Y_10;
			unsigned char _Y_16;
			unsigned char _Y_17;
			/*pre-SFC*/
			/*transitions G1*/
			_Y_9 = _X_10 && cycleInProgress;
			_Y_15 = _X_11 && (cycleInProgress && kneadingRequest);
			_Y_14 = _X_12 && !kneadingRequest;
			_Y_13 = _X_13 && (_TIMER_13 >= kneadingDuration * 1000000.0 / CLOCK_PERIOD);
			_Y_12 = _X_14 && (mixtureLevel <= 1);
			_Y_11 = _X_15 && (nbCycles < nbOfCleanCycles);
			_Y_10 = _X_17 && (_TIMER_17 >= 500 * 1000.0 / CLOCK_PERIOD);
			_Y_16 = _X_15 && (!_Y_11 && (nbCycles >= nbOfCleanCycles));
			_Y_17 = _X_16 && (_TIMER_16 >= cleaningDuration * 1000000.0 / CLOCK_PERIOD);
			/*evolutions G1*/
			if (_Y_9) {
				_X_10 = 0;
			}
			if (_Y_15) {
				_X_11 = 0;
			}
			if (_Y_14) {
				_X_12 = 0;
			}
			if (_Y_13) {
				_X_13 = 0;
			}
			if (_Y_12) {
				_X_14 = 0;
			}
			if (_Y_11) {
				_X_15 = 0;
			}
			if (_Y_10) {
				_X_17 = 0;
			}
			if (_Y_16) {
				_X_15 = 0;
			}
			if (_Y_17) {
				_X_16 = 0;
			}
			if (_Y_9) {
				_X_11 = 1;
			}
			if (_Y_15) {
				_X_12 = 1;
			}
			if (_Y_14) {
				_X_13 = 1;
			}
			if (_Y_13) {
				_X_14 = 1;
			}
			if (_Y_12) {
				_X_15 = 1;
			}
			if (_Y_11) {
				_X_17 = 1;
			}
			if (_Y_10) {
				_X_11 = 1;
			}
			if (_Y_16) {
				_X_16 = 1;
			}
			if (_Y_17) {
				_X_17 = 1;
			}
			/*timers G1*/
			if (_X_13) {
				if (CB_edge_bool(_X_13, _X_13_PREV) > 0) {
					_TIMER_13 = 0;
				}
				else {
					if (_TIMER_13 < _MAX_TIMER) {
						_TIMER_13 = _TIMER_13 + 1;
					}
				}
			}
			if (_X_17) {
				if (CB_edge_bool(_X_17, _X_17_PREV) > 0) {
					_TIMER_17 = 0;
				}
				else {
					if (_TIMER_17 < _MAX_TIMER) {
						_TIMER_17 = _TIMER_17 + 1;
					}
				}
			}
			if (_X_16) {
				if (CB_edge_bool(_X_16, _X_16_PREV) > 0) {
					_TIMER_16 = 0;
				}
				else {
					if (_TIMER_16 < _MAX_TIMER) {
						_TIMER_16 = _TIMER_16 + 1;
					}
				}
			}
			/*actions G1*/
			if (CB_edge_bool(_X_12, _X_12_PREV) < 0) {
				knead = 0;
			}
			if (CB_edge_bool(_X_13, _X_13_PREV) < 0) {
				knead = 0;
			}
			if (CB_edge_bool(_X_14, _X_14_PREV) < 0) {
				evacuateMixture = 0;
			}
			if (CB_edge_bool(_X_17, _X_17_PREV) < 0) {
				kneadingOK = 0;
			}
			if (CB_edge_bool(_X_16, _X_16_PREV) < 0) {
				clean = 0;
				knead = 0;
			}
			if (_X_10) {
				nbCycles = 0;
			}
			if (_X_12) {
				knead = 1;
			}
			if (_X_13) {
				knead = 1;
			}
			if (_X_14) {
				evacuateMixture = 1;
			}
			if (_X_15) {
				if (CB_edge_bool(_X_15, _X_15_PREV) > 0) {
					nbCycles = nbCycles + 1;
				}
			}
			if (_X_17) {
				kneadingOK = 1;
			}
			if (_X_16) {
				clean = 1;
				knead = 1;
				nbCycles = 0;
			}
			/*post-SFC*/
			if (!cycleInProgress) {
				knead = 0;
				clean = 0;
				evacuateMixture = 0;
			}
			cleaningEnd = !cycleInProgress || !clean;
			evacMixtureEnd = !cycleInProgress || !evacuateMixture;
			_X_13_PREV = _X_13;
			_X_16_PREV = _X_16;
			_X_14_PREV = _X_14;
			_X_17_PREV = _X_17;
			_X_12_PREV = _X_12;
			_X_15_PREV = _X_15;
		}

		CB_post_bool(kneading_kneadingOK);
		CB_post_bool(kneading_knead);
		CB_post_bool(kneading_clean);
		CB_post_bool(kneading_cleaningEnd);
		CB_post_bool(kneading_evacuateMixture);
		CB_post_bool(kneading_evacMixtureEnd);

		/******************** Post-conditions execution *********************/

		/*no Post-conditions*/
	}

	/*************************** self update ****************************/

	self.Bool += 14;
	self.Int += 7;

	return 0;
}

