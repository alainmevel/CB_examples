/*2023-10-03T11:13:02-01:00*/

/********************************************************************
 * motorized_valve.c
 * 
 * generated by: plcgen 3.1.391
 ********************************************************************/

#include "cb_comp.h"
#include "iec_1131.h"

#include "motorized_valve.h"



/**************************** Variables *****************************/

CB_Index motorized_valve__num = 0;
CB_Mem_Bool *motorized_valve_voltage380;
CB_Mem_Bool *motorized_valve_cmdSupply;
CB_Mem_Bool *motorized_valve_sensorSupply;
CB_Mem_Bool *motorized_valve_openCmd;
CB_Mem_Bool *motorized_valve_closeCmd;
CB_Mem_Float *motorized_valve_inputFlow;
CB_Mem_Bool *motorized_valve_openedSensor;
CB_Mem_Bool *motorized_valve_closedSensor;
CB_Mem_Bool *motorized_valve_thermal;
CB_Mem_Bool *motorized_valve_openFB;
CB_Mem_Bool *motorized_valve_closeFB;
CB_Mem_Float *motorized_valve_outputFlow;
CB_Mem_Float *motorized_valve_percentOpening;
CB_Mem_Float *motorized_valve_increment;
CB_Mem_Bool *motorized_valve_memoOpen;
CB_Mem_Bool *motorized_valve_memoClose;
CB_Mem_Bool *motorized_valve_openState;
CB_Mem_Bool *motorized_valve_closeState;
CB_Mem_Float *motorized_valve_openingVal;
CB_Mem_Float *motorized_valve_unit;
CB_Mem_Float *motorized_valve_openingTime;
CB_Mem_Bool *motorized_valve_thermalLogic;
CB_Mem_Bool *motorized_valve_openFbLogic;
CB_Mem_Bool *motorized_valve_closeFbLogic;
CB_Mem_Bool *motorized_valve_openedSensorLogic;
CB_Mem_Bool *motorized_valve_closedSensorLogic;
CB_Mem_Float *motorized_valve_flowMax;
CB_Mem_Bool *motorized_valve_flowPerHour;
CB_Mem_Bool *motorized_valve_flowPerMiinuute;
CB_Mem_Bool *motorized_valve_d_locking;
CB_Mem_Float *motorized_valve_v_d_locking;
CB_Mem_Bool *motorized_valve_d_flow;
CB_Mem_Float *motorized_valve_v_d_flow;
CB_Mem_Bool *motorized_valve_d_electrical;
CB_Mem_Bool *motorized_valve_v_d_electrical;
CB_Mem_Bool *motorized_valve_d_closedSensor;
CB_Mem_Bool *motorized_valve_v_d_closedSensor;
CB_Mem_Bool *motorized_valve_d_openedSensor;
CB_Mem_Bool *motorized_valve_v_d_openedSensor;
CB_Mem_Bool *motorized_valve_d_closeFB;
CB_Mem_Bool *motorized_valve_v_d_closeFB;
CB_Mem_Bool *motorized_valve_d_openFB;
CB_Mem_Bool *motorized_valve_v_d_openFB;

/**************************** Variables *****************************/

#define voltage380 (motorized_valve_voltage380->CB_current_value)
#define cmdSupply (motorized_valve_cmdSupply->CB_current_value)
#define sensorSupply (motorized_valve_sensorSupply->CB_current_value)
#define openCmd (motorized_valve_openCmd->CB_current_value)
#define closeCmd (motorized_valve_closeCmd->CB_current_value)
#define inputFlow (motorized_valve_inputFlow->CB_current_value)
#define openedSensor (motorized_valve_openedSensor->CB_current_value)
#define closedSensor (motorized_valve_closedSensor->CB_current_value)
#define thermal (motorized_valve_thermal->CB_current_value)
#define openFB (motorized_valve_openFB->CB_current_value)
#define closeFB (motorized_valve_closeFB->CB_current_value)
#define outputFlow (motorized_valve_outputFlow->CB_current_value)
#define percentOpening (motorized_valve_percentOpening->CB_current_value)
#define increment (motorized_valve_increment->CB_current_value)
#define memoOpen (motorized_valve_memoOpen->CB_current_value)
#define memoClose (motorized_valve_memoClose->CB_current_value)
#define openState (motorized_valve_openState->CB_current_value)
#define closeState (motorized_valve_closeState->CB_current_value)
#define openingVal (motorized_valve_openingVal->CB_current_value)
#define unit (motorized_valve_unit->CB_current_value)
#define openingTime (motorized_valve_openingTime->CB_current_value)
#define thermalLogic (motorized_valve_thermalLogic->CB_current_value)
#define openFbLogic (motorized_valve_openFbLogic->CB_current_value)
#define closeFbLogic (motorized_valve_closeFbLogic->CB_current_value)
#define openedSensorLogic (motorized_valve_openedSensorLogic->CB_current_value)
#define closedSensorLogic (motorized_valve_closedSensorLogic->CB_current_value)
#define flowMax (motorized_valve_flowMax->CB_current_value)
#define flowPerHour (motorized_valve_flowPerHour->CB_current_value)
#define flowPerMiinuute (motorized_valve_flowPerMiinuute->CB_current_value)
#define d_locking (motorized_valve_d_locking->CB_current_value)
#define v_d_locking (motorized_valve_v_d_locking->CB_current_value)
#define d_flow (motorized_valve_d_flow->CB_current_value)
#define v_d_flow (motorized_valve_v_d_flow->CB_current_value)
#define d_electrical (motorized_valve_d_electrical->CB_current_value)
#define v_d_electrical (motorized_valve_v_d_electrical->CB_current_value)
#define d_closedSensor (motorized_valve_d_closedSensor->CB_current_value)
#define v_d_closedSensor (motorized_valve_v_d_closedSensor->CB_current_value)
#define d_openedSensor (motorized_valve_d_openedSensor->CB_current_value)
#define v_d_openedSensor (motorized_valve_v_d_openedSensor->CB_current_value)
#define d_closeFB (motorized_valve_d_closeFB->CB_current_value)
#define v_d_closeFB (motorized_valve_v_d_closeFB->CB_current_value)
#define d_openFB (motorized_valve_d_openFB->CB_current_value)
#define v_d_openFB (motorized_valve_v_d_openFB->CB_current_value)


/************************ Components offsets ************************/


/********************* Initialization function **********************/

int _equipment_library__motorized_valve_init(void)
{
	(motorized_valve_voltage380)->CB_current_value = 1; /*voltage380*/
	(motorized_valve_cmdSupply)->CB_current_value = 1; /*cmdSupply*/
	(motorized_valve_sensorSupply)->CB_current_value = 1; /*sensorSupply*/
	(self.Float+3)->CB_current_value = 2.0; /*openingTime*/
	(self.Bool+5)->CB_current_value = 1; /*openFbLogic*/
	(self.Bool+6)->CB_current_value = 1; /*closeFbLogic*/
	(self.Bool+7)->CB_current_value = 1; /*openedSensorLogic*/
	(self.Bool+8)->CB_current_value = 1; /*closedSensorLogic*/
	(self.Float+4)->CB_current_value = 10000.0; /*flowMax*/
	(self.Bool+9)->CB_current_value = 1; /*flowPerHour*/
	self.Bool+=23;
	self.Float+=7;


	return 0;
}


/************************ Behavior function *************************/

int equipment_library__motorized_valve(void)
{
	if (exec_term_node(self_num)) {

		/*********************** Internals variables ************************/

		motorized_valve_increment = self.Float+0;
		motorized_valve_memoOpen = self.Bool+0;
		motorized_valve_memoClose = self.Bool+1;
		motorized_valve_openState = self.Bool+2;
		motorized_valve_closeState = self.Bool+3;
		motorized_valve_openingVal = self.Float+1;
		motorized_valve_unit = self.Float+2;
		motorized_valve_openingTime = self.Float+3;
		motorized_valve_thermalLogic = self.Bool+4;
		motorized_valve_openFbLogic = self.Bool+5;
		motorized_valve_closeFbLogic = self.Bool+6;
		motorized_valve_openedSensorLogic = self.Bool+7;
		motorized_valve_closedSensorLogic = self.Bool+8;
		motorized_valve_flowMax = self.Float+4;
		motorized_valve_flowPerHour = self.Bool+9;
		motorized_valve_flowPerMiinuute = self.Bool+10;
		motorized_valve_d_locking = self.Bool+11;
		motorized_valve_v_d_locking = self.Float+5;
		motorized_valve_d_flow = self.Bool+12;
		motorized_valve_v_d_flow = self.Float+6;
		motorized_valve_d_electrical = self.Bool+13;
		motorized_valve_v_d_electrical = self.Bool+14;
		motorized_valve_d_closedSensor = self.Bool+15;
		motorized_valve_v_d_closedSensor = self.Bool+16;
		motorized_valve_d_openedSensor = self.Bool+17;
		motorized_valve_v_d_openedSensor = self.Bool+18;
		motorized_valve_d_closeFB = self.Bool+19;
		motorized_valve_v_d_closeFB = self.Bool+20;
		motorized_valve_d_openFB = self.Bool+21;
		motorized_valve_v_d_openFB = self.Bool+22;

		/********************* Pre-conditions execution *********************/

		/*no Pre-conditions*/

		/************************ Behavior execution ************************/

		{
			/* -----------------------------------------------------------------	*/
			/* Type : Model of Operative Behaviour					*/
			/* Catégorie :   batch							*/
			/* Author : Dassault Systemes						*/
			/* Update date : June 2018							*/
			/* -----------------------------------------------------------------	*/
			/* This module simulates the behaviour of a motorized valve and its 	*/
			/* electrical control logic.						*/
			/* ----------------------------------------------------------------	*/

			/* ----------------------------------------------------------------	*/
			/* Management of orders from Control Part					*/
			/*	if there is no power supply for command 				*/
			/*     the contactors don't understand the control order		*/
			/* ----------------------------------------------------------------	*/
			if (openCmd && !memoClose && cmdSupply) memoOpen = 1;
			if (!openCmd || !cmdSupply) memoOpen = 0;
			if (!memoOpen && closeCmd && cmdSupply) memoClose = 1;
			if (!closeCmd || !cmdSupply) memoClose = 0;

			/* ----------------------------------------------------------------	*/
			/* Calculation of the on-state of contactors				*/
			/* ----------------------------------------------------------------	*/
			openState = memoOpen & voltage380 & ! d_electrical;
			closeState = memoClose & voltage380 & ! d_electrical;

			/* ----------------------------------------------------------------	*/
			/* Management of opening							*/
			/* ----------------------------------------------------------------	*/

			/* Compute the increment of opening according to the simulation clock*/
			increment = CLOCK_PERIOD/1000000;

			/* Compute the opening	*/
			if (! d_locking) {
				if (openState) {
					openingVal += increment;
					if (openingVal > openingTime)
						openingVal = openingTime;
				}
				if (closeState) {
					openingVal -= increment;
					if (openingVal < 0.0)
						openingVal = 0.0;
				}
			}

			/* ----------------------------------------------------------------	*/
			/* Compute the percentage of opening					*/
			/* ----------------------------------------------------------------	*/
			if (openingTime > 0.0)
				percentOpening = ((openingVal / openingTime) * 100);

			/* ----------------------------------------------------------------	*/
			/* Management of flow rate 							*/
			/* ----------------------------------------------------------------	*/
			if (d_flow)
				outputFlow = v_d_flow;
			else {
				outputFlow = percentOpening / 100.0 * inputFlow;
				if (outputFlow > inputFlow) outputFlow = inputFlow;
				if (flowPerHour) unit = 3600.0;
				else if (flowPerMiinuute) unit = 60.0;
					else unit = 1.0;
				if (outputFlow > (flowMax * CLOCK_PERIOD / 1000000)  / unit)
					outputFlow = ((flowMax * CLOCK_PERIOD / 1000000)  / unit) * (percentOpening  /100.0);
			}

			/* ----------------------------------------------------------------	*/
			/* Management of the thermal feedback					*/
			/* ----------------------------------------------------------------	*/
			if (d_electrical) thermal = v_d_electrical;
			else
				thermal = ! thermalLogic && sensorSupply;

			/* ----------------------------------------------------------------	*/
			/* Management of contatcors' feedback					*/
			/* ----------------------------------------------------------------	*/
			if (d_openFB) openFB = v_d_openFB;
			else
				openFB = (memoOpen ^ ! openFbLogic) && sensorSupply;

			if (d_closeFB) closeFB = v_d_closeFB;
			else
				closeFB = (memoClose ^ ! closeFbLogic) && sensorSupply;


			/* ----------------------------------------------------------------	*/
			/* Management of sensors' state						*/
			/* ----------------------------------------------------------------	*/
			if (d_openedSensor) openedSensor = v_d_openedSensor;
			else
				openedSensor = ((openingVal >= openingTime) ^ ! openedSensorLogic) && sensorSupply;

			if (d_closedSensor) closedSensor = v_d_closedSensor;
			else
				closedSensor = ((openingVal == 0.0) ^ ! closedSensorLogic) && sensorSupply;




		}

		CB_post_bool(motorized_valve_openedSensor);
		CB_post_bool(motorized_valve_closedSensor);
		CB_post_bool(motorized_valve_thermal);
		CB_post_bool(motorized_valve_openFB);
		CB_post_bool(motorized_valve_closeFB);
		CB_post_float(motorized_valve_outputFlow);
		CB_post_float(motorized_valve_percentOpening);

		/******************** Post-conditions execution *********************/

		/*no Post-conditions*/
	}

	/*************************** self update ****************************/

	self.Bool += 23;
	self.Float += 7;

	return 0;
}

