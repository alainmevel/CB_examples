/*2023-10-03T11:12:59-01:00*/

/********************************************************************
 * hopper.c
 * 
 * generated by: plcgen 3.1.391
 ********************************************************************/

#include "cb_comp.h"
#include "iec_1131.h"

#include "hopper.h"



/**************************** Variables *****************************/

CB_Index hopper__num = 0;
CB_Mem_Float *hopper_volumeExtraction;
CB_Mem_Float *hopper_volumeFilling;
CB_Mem_Float *hopper_densityInput;
CB_Mem_Float *hopper_levelHopper;
CB_Mem_Float *hopper_densityOutput;
CB_Mem_Float *hopper_weight;
CB_Mem_Float *hopper_percentLevel;
CB_Mem_Float *hopper_volumeOutput;
CB_Mem_Float *hopper_density;
CB_Mem_Float *hopper_realLevel;
CB_Mem_Float *hopper_debug;
CB_Mem_Float *hopper_capacity;
CB_Mem_Bool *hopper_d_level;
CB_Mem_Float *hopper_v_d_level;

/**************************** Variables *****************************/

#define volumeExtraction (hopper_volumeExtraction->CB_current_value)
#define volumeFilling (hopper_volumeFilling->CB_current_value)
#define densityInput (hopper_densityInput->CB_current_value)
#define levelHopper (hopper_levelHopper->CB_current_value)
#define densityOutput (hopper_densityOutput->CB_current_value)
#define weight (hopper_weight->CB_current_value)
#define percentLevel (hopper_percentLevel->CB_current_value)
#define volumeOutput (hopper_volumeOutput->CB_current_value)
#define density (hopper_density->CB_current_value)
#define realLevel (hopper_realLevel->CB_current_value)
#define debug (hopper_debug->CB_current_value)
#define capacity (hopper_capacity->CB_current_value)
#define d_level (hopper_d_level->CB_current_value)
#define v_d_level (hopper_v_d_level->CB_current_value)


/************************ Components offsets ************************/


/********************* Initialization function **********************/

int _equipment_library__hopper_init(void)
{
	(hopper_densityInput)->CB_current_value = 1.0; /*densityInput*/
	(self.Float+3)->CB_current_value = 250.0; /*capacity*/
	self.Bool+=1;
	self.Float+=5;


	return 0;
}


/************************ Behavior function *************************/

int equipment_library__hopper(void)
{
	if (exec_term_node(self_num)) {

		/*********************** Internals variables ************************/

		hopper_density = self.Float+0;
		hopper_realLevel = self.Float+1;
		hopper_debug = self.Float+2;
		hopper_capacity = self.Float+3;
		hopper_d_level = self.Bool+0;
		hopper_v_d_level = self.Float+4;

		/********************* Pre-conditions execution *********************/

		/*no Pre-conditions*/

		/************************ Behavior execution ************************/

		{
			/* -----------------------------------------------------------------	*/
			/* Type : Model of Operative Behaviour					*/
			/* Catégorie :   batch							*/
			/* Author : Dassault Systemes						*/
			/* Update date : June 2018							*/
			/* -----------------------------------------------------------------	*/
			/* This module simulates the behaviour of a hopper.			*/
			/* The hopper computes the weight and the volume of material		*/
			/* according to the volumes of received and extracted material	*/
			/* ----------------------------------------------------------------	*/


			/* ---------------------------------------------*/
			/* compute realLevel 				*/
			/* ---------------------------------------------*/
			if (density == 0.0)
				density = densityInput;

			realLevel += volumeFilling;   /* Physical level after filling */

			if (realLevel > capacity)   realLevel = capacity;
			if (realLevel < 0.0) realLevel = 0.0;
			if (d_level)   levelHopper = v_d_level;
			else  levelHopper += volumeFilling  - volumeExtraction;


			if (levelHopper > capacity)  levelHopper = capacity;
			if (levelHopper < 0.0) levelHopper = 0.0;

			/* -------------------------------------------- */
			/* percent of capacity 				*/
			/* -------------------------------------------- */
			if ( capacity!=0.0) percentLevel = levelHopper / capacity * 100.0;


			if(volumeExtraction !=0.0) {
			         if( (volumeExtraction <=realLevel)&&(realLevel !=0.0))  {
			               volumeOutput=volumeExtraction;
			         }
			         else {
			                volumeOutput=realLevel;
			         }
			}
			else volumeOutput=0.0;

			realLevel -= volumeExtraction; /* Physical level after extraction */
			if (realLevel < 0.0) realLevel = 0.0;
			/* -------------------------------------------- */
			/* compute weight/density		 	  	*/
			/* -------------------------------------------- */
			weight = levelHopper * density;
			densityOutput = density;

			if (levelHopper == 0.0)
				density = 0.0;



		}

		CB_post_float(hopper_levelHopper);
		CB_post_float(hopper_densityOutput);
		CB_post_float(hopper_weight);
		CB_post_float(hopper_percentLevel);
		CB_post_float(hopper_volumeOutput);

		/******************** Post-conditions execution *********************/

		/*no Post-conditions*/
	}

	/*************************** self update ****************************/

	self.Bool += 1;
	self.Float += 5;

	return 0;
}

