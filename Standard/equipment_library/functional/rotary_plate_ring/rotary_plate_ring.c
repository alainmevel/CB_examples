/*2023-10-03T11:12:55-01:00*/

/********************************************************************
 * rotary_plate_ring.c
 * 
 * generated by: plcgen 3.1.391
 ********************************************************************/

#include "cb_comp.h"
#include "iec_1131.h"
#include "cb_products_iec.h"

#include "rotary_plate_ring.h"


#ifndef PI
#define PI 3.1415926535898
#endif

/**************************** Variables *****************************/

CB_Index rotary_plate_ring__num = 0;
CB_Mem_Float *rotary_plate_ring_incShiftX;
CB_Mem_Float *rotary_plate_ring_incShiftZ;
CB_Mem_Float *rotary_plate_ring_incShiftY;
CB_Mem_Float *rotary_plate_ring_rotationSpeed;
CB_Mem_Float *rotary_plate_ring_angleRotationRad;
CB_Mem_Float *rotary_plate_ring_incRotation;
CB_Mem_Float *rotary_plate_ring_centerX;
CB_Mem_Float *rotary_plate_ring_centerY;
CB_Mem_Float *rotary_plate_ring_centerZ;
CB_Mem_Float *rotary_plate_ring_angleRotationDeg;
CB_Mem_Int *rotary_plate_ring_status_act_prod;
CB_Mem_Float *rotary_plate_ring_m11;
CB_Mem_Float *rotary_plate_ring_m12;
CB_Mem_Float *rotary_plate_ring_m13;
CB_Mem_Float *rotary_plate_ring_m14;
CB_Mem_Float *rotary_plate_ring_m21;
CB_Mem_Float *rotary_plate_ring_m22;
CB_Mem_Float *rotary_plate_ring_m23;
CB_Mem_Float *rotary_plate_ring_m24;
CB_Mem_Float *rotary_plate_ring_m31;
CB_Mem_Float *rotary_plate_ring_m32;
CB_Mem_Float *rotary_plate_ring_m33;
CB_Mem_Float *rotary_plate_ring_m34;
CB_Mem_Float *rotary_plate_ring_m41;
CB_Mem_Float *rotary_plate_ring_m42;
CB_Mem_Float *rotary_plate_ring_m43;
CB_Mem_Float *rotary_plate_ring_m44;
CB_Mem_Float *rotary_plate_ring_incrementRotation;
CB_Mem_Float *rotary_plate_ring_positionsRecalage;
CB_Mem_Float *rotary_plate_ring_deltaPos;
CB_Mem_Bool *rotary_plate_ring_d_locking;
CB_Mem_Float *rotary_plate_ring_v_d_locking;
CB_Mem_Bool *rotary_plate_ring_d_position;
CB_Mem_Float *rotary_plate_ring_v_d_position;

/**************************** Variables *****************************/

#define incShiftX (rotary_plate_ring_incShiftX->CB_current_value)
#define incShiftZ (rotary_plate_ring_incShiftZ->CB_current_value)
#define incShiftY (rotary_plate_ring_incShiftY->CB_current_value)
#define rotationSpeed (rotary_plate_ring_rotationSpeed->CB_current_value)
#define angleRotationRad (rotary_plate_ring_angleRotationRad->CB_current_value)
#define incRotation (rotary_plate_ring_incRotation->CB_current_value)
#define centerX (rotary_plate_ring_centerX->CB_current_value)
#define centerY (rotary_plate_ring_centerY->CB_current_value)
#define centerZ (rotary_plate_ring_centerZ->CB_current_value)
#define angleRotationDeg (rotary_plate_ring_angleRotationDeg->CB_current_value)
#define status_act_prod (rotary_plate_ring_status_act_prod->CB_current_value)
#define m11 (rotary_plate_ring_m11->CB_current_value)
#define m12 (rotary_plate_ring_m12->CB_current_value)
#define m13 (rotary_plate_ring_m13->CB_current_value)
#define m14 (rotary_plate_ring_m14->CB_current_value)
#define m21 (rotary_plate_ring_m21->CB_current_value)
#define m22 (rotary_plate_ring_m22->CB_current_value)
#define m23 (rotary_plate_ring_m23->CB_current_value)
#define m24 (rotary_plate_ring_m24->CB_current_value)
#define m31 (rotary_plate_ring_m31->CB_current_value)
#define m32 (rotary_plate_ring_m32->CB_current_value)
#define m33 (rotary_plate_ring_m33->CB_current_value)
#define m34 (rotary_plate_ring_m34->CB_current_value)
#define m41 (rotary_plate_ring_m41->CB_current_value)
#define m42 (rotary_plate_ring_m42->CB_current_value)
#define m43 (rotary_plate_ring_m43->CB_current_value)
#define m44 (rotary_plate_ring_m44->CB_current_value)
#define incrementRotation (rotary_plate_ring_incrementRotation->CB_current_value)
#define positionsRecalage(i) (rotary_plate_ring_positionsRecalage[i+1].CB_current_value)
#define deltaPos (rotary_plate_ring_deltaPos->CB_current_value)
#define d_locking (rotary_plate_ring_d_locking->CB_current_value)
#define v_d_locking (rotary_plate_ring_v_d_locking->CB_current_value)
#define d_position (rotary_plate_ring_d_position->CB_current_value)
#define v_d_position (rotary_plate_ring_v_d_position->CB_current_value)


/************************ Components offsets ************************/


/********************* Initialization function **********************/

int _equipment_library__rotary_plate_ring_init(void)
{
	(self.Float+0)->CB_current_value = 1.0; /*m11*/
	(self.Float+5)->CB_current_value = 1.0; /*m22*/
	(self.Float+10)->CB_current_value = 1.0; /*m33*/
	(self.Float+15)->CB_current_value = 1.0; /*m44*/
	(self.Float+17+3)->CB_current_value = 90.0; /*positionsRecalage[2]*/
	(self.Float+17+4)->CB_current_value = 180.0; /*positionsRecalage[3]*/
	(self.Float+17+5)->CB_current_value = 270.0; /*positionsRecalage[4]*/
	(self.Float+17+6)->CB_current_value = 360.0; /*positionsRecalage[5]*/
	(self.Float+24)->CB_current_value = 10.0; /*deltaPos*/
	self.Bool+=2;
	self.Int+=1;
	self.Float+=27;


	return 0;
}


/************************ Behavior function *************************/

int equipment_library__rotary_plate_ring(void)
{
	if (exec_term_node(self_num)) {

		/*********************** Internals variables ************************/

		rotary_plate_ring_status_act_prod = self.Int+0;
		rotary_plate_ring_m11 = self.Float+0;
		rotary_plate_ring_m12 = self.Float+1;
		rotary_plate_ring_m13 = self.Float+2;
		rotary_plate_ring_m14 = self.Float+3;
		rotary_plate_ring_m21 = self.Float+4;
		rotary_plate_ring_m22 = self.Float+5;
		rotary_plate_ring_m23 = self.Float+6;
		rotary_plate_ring_m24 = self.Float+7;
		rotary_plate_ring_m31 = self.Float+8;
		rotary_plate_ring_m32 = self.Float+9;
		rotary_plate_ring_m33 = self.Float+10;
		rotary_plate_ring_m34 = self.Float+11;
		rotary_plate_ring_m41 = self.Float+12;
		rotary_plate_ring_m42 = self.Float+13;
		rotary_plate_ring_m43 = self.Float+14;
		rotary_plate_ring_m44 = self.Float+15;
		rotary_plate_ring_incrementRotation = self.Float+16;
		rotary_plate_ring_positionsRecalage = self.Float+17;
		rotary_plate_ring_deltaPos = self.Float+24;
		rotary_plate_ring_d_locking = self.Bool+0;
		rotary_plate_ring_v_d_locking = self.Float+25;
		rotary_plate_ring_d_position = self.Bool+1;
		rotary_plate_ring_v_d_position = self.Float+26;

		/********************* Pre-conditions execution *********************/

		/*no Pre-conditions*/

		/************************ Actor Myself init *************************/

		setMyselfFor(self_num);

		/************************ Behavior execution ************************/

		{
			/* ----------------------------------------------------------------	*/
			/* Type : Model of Operative Behaviour					*/
			/* Category :  Actors and Products						*/
			/* Author : Dassault Systemes						*/
			/* Update date : June 2018							*/
			/* ----------------------------------------------------------------	*/
			/* This module simulates the behaviour of a rotary plate ring.	*/
			/* It takes a rotation speed as input and can move actors and		*/
			/* products that are in interaction.					*/
			/* ----------------------------------------------------------------	*/

			/* ----------------------------------------------------------------	*/
			/* Management of the rotation						*/
			/* ----------------------------------------------------------------	*/
			if (d_locking) 
				incrementRotation = 0;
			else {
				/* Compute the increment of rotation according to the simulation clock	*/
				incrementRotation = rotationSpeed * (CLOCK_PERIOD/1000000.0) ;	
			}

			/* ----------------------------------------------------------------	*/
			/* Request for updating the plate ring's position 			*/
			/* ----------------------------------------------------------------	*/
			if (d_position) {
				incrementRotation = v_d_position - getAngleZ(myself);
				d_position = 0;
			}

			/* ----------------------------------------------------------------	*/
			/* Request for align the tipper in fixed position 			*/
			/* ----------------------------------------------------------------	*/
			if (rotationSpeed == 0.0) {
				CB_Int i;
				CB_Float currentAngle;
				currentAngle=getAngleZ(myself);  
				for (i=1; i<=5; i++) {
					if ((currentAngle- deltaPos < positionsRecalage(i)) && (currentAngle+ deltaPos > positionsRecalage(i))) {
						incrementRotation = positionsRecalage(i) - currentAngle;
						break;
					 }
				}
			}
			/* ----------------------------------------------------------------	*/
			/* Rotation of the plate ring						*/
			/* ----------------------------------------------------------------	*/
			if (incrementRotation != 0.0)
				rotateCenterBy(myself, 0.0, 0.0, incrementRotation);

			/* ----------------------------------------------------------------	*/
			/* Compute the rotation angle in degrees and in radians		*/
			/* ----------------------------------------------------------------	*/
			angleRotationDeg = getAngleZ(myself);
			angleRotationRad = angleRotationDeg * PI/180.0;


			/* ----------------------------------------------------------------	*/
			/* Shift the plate ring			    				*/
			/* ----------------------------------------------------------------	*/
			if (incShiftX != 0.0) moveXBy(myself, incShiftX);
			if (incShiftY != 0.0) moveYBy(myself, incShiftY);
			if (incShiftZ != 0.0) moveZBy(myself, incShiftZ);

			/* ----------------------------------------------------------------	*/
			/* Compute the rotation center of the plate ring			*/
			/* ----------------------------------------------------------------	*/
			centerX = getCenterX(myself);
			centerY = getCenterY(myself);
			centerZ = getCenterZ(myself);

			/* ----------------------------------------------------------------	*/
			/* Output of the rotation angle for rotated actors/products		*/
			/* ----------------------------------------------------------------	*/
			incRotation = incrementRotation;


		}

		CB_post_float(rotary_plate_ring_angleRotationRad);
		CB_post_float(rotary_plate_ring_incRotation);
		CB_post_float(rotary_plate_ring_centerX);
		CB_post_float(rotary_plate_ring_centerY);
		CB_post_float(rotary_plate_ring_centerZ);
		CB_post_float(rotary_plate_ring_angleRotationDeg);

		/******************** Post-conditions execution *********************/

		/*no Post-conditions*/
	}

	/*************************** self update ****************************/

	self.Bool += 2;
	self.Int += 1;
	self.Float += 27;

	return 0;
}

