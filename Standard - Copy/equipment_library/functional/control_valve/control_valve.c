/*2023-10-03T11:12:59-01:00*/

/********************************************************************
 * control_valve.c
 * 
 * generated by: plcgen 3.1.391
 ********************************************************************/

#include "cb_comp.h"
#include "iec_1131.h"

#include "control_valve.h"

#include <math.h>

/**************************** Variables *****************************/

CB_Index control_valve__num = 0;
CB_Mem_Float *control_valve_inputFlow;
CB_Mem_Bool *control_valve_voltage380;
CB_Mem_Bool *control_valve_cmdSupply;
CB_Mem_Bool *control_valve_sensorSupply;
CB_Mem_Bool *control_valve_onCmd;
CB_Mem_Float *control_valve_setpoint;
CB_Mem_Bool *control_valve_openedSensor;
CB_Mem_Bool *control_valve_closedSensor;
CB_Mem_Float *control_valve_outputFlow;
CB_Mem_Float *control_valve_percentOpening;
CB_Mem_Float *control_valve_increment;
CB_Mem_Float *control_valve_openingVal;
CB_Mem_Float *control_valve_unit;
CB_Mem_Int *control_valve_openingTime;
CB_Mem_Float *control_valve_flowMax;
CB_Mem_Bool *control_valve_openedSensorLogic;
CB_Mem_Bool *control_valve_closedSensorLogic;
CB_Mem_Bool *control_valve_flowPerHour;
CB_Mem_Bool *control_valve_flowPerMinute;
CB_Mem_Bool *control_valve_d_locking;
CB_Mem_Float *control_valve_v_d_locking;
CB_Mem_Bool *control_valve_d_flow;
CB_Mem_Float *control_valve_v_d_flow;
CB_Mem_Bool *control_valve_d_electrical;
CB_Mem_Bool *control_valve_v_d_electrical;
CB_Mem_Bool *control_valve_d_closedSensor;
CB_Mem_Bool *control_valve_v_d_closedSensor;
CB_Mem_Bool *control_valve_d_openedSensor;
CB_Mem_Bool *control_valve_v_d_openedSensor;

/**************************** Variables *****************************/

#define inputFlow (control_valve_inputFlow->CB_current_value)
#define voltage380 (control_valve_voltage380->CB_current_value)
#define cmdSupply (control_valve_cmdSupply->CB_current_value)
#define sensorSupply (control_valve_sensorSupply->CB_current_value)
#define onCmd (control_valve_onCmd->CB_current_value)
#define setpoint (control_valve_setpoint->CB_current_value)
#define openedSensor (control_valve_openedSensor->CB_current_value)
#define closedSensor (control_valve_closedSensor->CB_current_value)
#define outputFlow (control_valve_outputFlow->CB_current_value)
#define percentOpening (control_valve_percentOpening->CB_current_value)
#define increment (control_valve_increment->CB_current_value)
#define openingVal (control_valve_openingVal->CB_current_value)
#define unit (control_valve_unit->CB_current_value)
#define openingTime (control_valve_openingTime->CB_current_value)
#define flowMax (control_valve_flowMax->CB_current_value)
#define openedSensorLogic (control_valve_openedSensorLogic->CB_current_value)
#define closedSensorLogic (control_valve_closedSensorLogic->CB_current_value)
#define flowPerHour (control_valve_flowPerHour->CB_current_value)
#define flowPerMinute (control_valve_flowPerMinute->CB_current_value)
#define d_locking (control_valve_d_locking->CB_current_value)
#define v_d_locking (control_valve_v_d_locking->CB_current_value)
#define d_flow (control_valve_d_flow->CB_current_value)
#define v_d_flow (control_valve_v_d_flow->CB_current_value)
#define d_electrical (control_valve_d_electrical->CB_current_value)
#define v_d_electrical (control_valve_v_d_electrical->CB_current_value)
#define d_closedSensor (control_valve_d_closedSensor->CB_current_value)
#define v_d_closedSensor (control_valve_v_d_closedSensor->CB_current_value)
#define d_openedSensor (control_valve_d_openedSensor->CB_current_value)
#define v_d_openedSensor (control_valve_v_d_openedSensor->CB_current_value)


/************************ Components offsets ************************/


/********************* Initialization function **********************/

int _equipment_library__control_valve_init(void)
{
	(control_valve_voltage380)->CB_current_value = 1; /*voltage380*/
	(control_valve_cmdSupply)->CB_current_value = 1; /*cmdSupply*/
	(control_valve_sensorSupply)->CB_current_value = 1; /*sensorSupply*/
	(self.Int+0)->CB_current_value = 2; /*openingTime*/
	(self.Float+3)->CB_current_value = 10000.0; /*flowMax*/
	(self.Bool+0)->CB_current_value = 1; /*openedSensorLogic*/
	(self.Bool+1)->CB_current_value = 1; /*closedSensorLogic*/
	(self.Bool+2)->CB_current_value = 1; /*flowPerHour*/
	self.Bool+=12;
	self.Int+=1;
	self.Float+=6;


	return 0;
}


/************************ Behavior function *************************/

int equipment_library__control_valve(void)
{
	if (exec_term_node(self_num)) {

		/*********************** Internals variables ************************/

		control_valve_increment = self.Float+0;
		control_valve_openingVal = self.Float+1;
		control_valve_unit = self.Float+2;
		control_valve_openingTime = self.Int+0;
		control_valve_flowMax = self.Float+3;
		control_valve_openedSensorLogic = self.Bool+0;
		control_valve_closedSensorLogic = self.Bool+1;
		control_valve_flowPerHour = self.Bool+2;
		control_valve_flowPerMinute = self.Bool+3;
		control_valve_d_locking = self.Bool+4;
		control_valve_v_d_locking = self.Float+4;
		control_valve_d_flow = self.Bool+5;
		control_valve_v_d_flow = self.Float+5;
		control_valve_d_electrical = self.Bool+6;
		control_valve_v_d_electrical = self.Bool+7;
		control_valve_d_closedSensor = self.Bool+8;
		control_valve_v_d_closedSensor = self.Bool+9;
		control_valve_d_openedSensor = self.Bool+10;
		control_valve_v_d_openedSensor = self.Bool+11;

		/********************* Pre-conditions execution *********************/

		/*no Pre-conditions*/

		/************************ Behavior execution ************************/

		{
			/* -----------------------------------------------------------------	*/
			/* Type : Model of Operative Behaviour					*/
			/* Catégorie :   batch							*/
			/* Author : Dassault Systemes						*/
			/* Update date : June 2018							*/
			/* -----------------------------------------------------------------	*/
			/* This module simulates the behaviour of a control valve and its	*/
			/* electrical control logic.						*/
			/* The setpoint can go from 0% up to +100%.				*/
			/* ----------------------------------------------------------------	*/

			/* ----------------------------------------------------------------	*/
			/* Management of opening							*/
			/* ----------------------------------------------------------------	*/
			if (( ! d_locking) && (voltage380) && (! d_electrical) && (cmdSupply) && (onCmd)) {

				/* Compute the increment of opening according to the simulation clock	*/
				if (openingTime > 0.0)
					increment = (100.0  / openingTime) * (CLOCK_PERIOD/1000000);

				/* Compute the opening	*/
				if ((openingVal < fabs(setpoint))  &&  (fabs(setpoint) <= 100.0)) {
					(openingVal) += increment;
					if (openingVal > fabs(setpoint)) openingVal = fabs(setpoint);
				}

				if (openingVal > fabs(setpoint)) {
					(openingVal) -= increment;
					if (openingVal < fabs(setpoint)) openingVal = fabs(setpoint);
					if (openingVal < 0.0) openingVal = 0.0;
				}
			}

			if (d_locking)
				openingVal = v_d_locking;

			/* ----------------------------------------------------------------	*/
			/* Compute the percentage of opening					*/
			/* ----------------------------------------------------------------	*/
			percentOpening = ((openingVal / 100.0) * 100.0);

			/* ----------------------------------------------------------------	*/
			/* Management of flow rate 	 						*/
			/* ----------------------------------------------------------------	*/
			if (d_flow)
				outputFlow = v_d_flow;
			else {
				if (flowPerHour) unit = 3600.0;
				else if (flowPerMinute) unit = 60.0;
					else unit = 1.0;
				
				outputFlow = ((flowMax * CLOCK_PERIOD / 1000000)  / unit) * (percentOpening  /100.0);
				if (outputFlow > inputFlow) outputFlow = inputFlow;
					
			}

			/* ----------------------------------------------------------------	*/
			/* Management of sensors' state						*/
			/* ----------------------------------------------------------------	*/
			if (d_openedSensor) openedSensor = v_d_openedSensor;
			else
				openedSensor = ((openingVal >= 100.0) ^ ! openedSensorLogic) && sensorSupply;

			if (d_closedSensor) closedSensor = v_d_closedSensor;
			else
				closedSensor = ((openingVal == 0.0) ^ ! closedSensorLogic) && sensorSupply;

		}

		CB_post_bool(control_valve_openedSensor);
		CB_post_bool(control_valve_closedSensor);
		CB_post_float(control_valve_outputFlow);
		CB_post_float(control_valve_percentOpening);

		/******************** Post-conditions execution *********************/

		/*no Post-conditions*/
	}

	/*************************** self update ****************************/

	self.Bool += 12;
	self.Int += 1;
	self.Float += 6;

	return 0;
}

